name: Build & Deploy to EC2

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_HOSTNAME: ${{ secrets.SSH_HOSTNAME }}
      SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json, libxml, mbstring, mysqlnd, openssl, pcre, pdo_sqlite, phar, posix, readline, reflection, session, simplexml, spl, sqlite3, standard, tokenizer, xmlreader, xmlwriter, zip, zlib

      - name: Install PHP dependencies
        run: composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Node dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Validate Secrets
        run: |
          echo "Validating required secrets..."
          if [ -z "$SSH_USER" ]; then
            echo "Error: SSH_USER secret is not set"
            exit 1
          fi
          if [ -z "$SSH_HOSTNAME" ]; then
            echo "Error: SSH_HOSTNAME secret is not set"
            exit 1
          fi
          if [ -z "$SSH_KEY" ]; then
            echo "Error: SSH_KEY secret is not set"
            exit 1
          fi
          if [ -z "$DEPLOY_PATH" ]; then
            echo "Error: DEPLOY_PATH secret is not set"
            exit 1
          fi
          echo "SSH_USER: $SSH_USER"
          echo "SSH_HOSTNAME: $SSH_HOSTNAME"
          echo "SSH_PORT: ${SSH_PORT:-22}"
          echo "DEPLOY_PATH: $DEPLOY_PATH"
          echo "All required secrets are set"

      - name: Prepare SSH
        run: |
          set -e
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write SSH key preserving exact format
          echo "$SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Verify key file exists and has content
          if [ ! -f ~/.ssh/id_rsa ]; then
            echo "Error: SSH key file was not created"
            exit 1
          fi
          
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "Error: SSH key file is empty"
            exit 1
          fi
          
          # Add host to known_hosts (using IP address directly)
          echo "Adding ${SSH_HOSTNAME} to known_hosts..."
          ssh-keyscan -p ${SSH_PORT:-22} -H ${SSH_HOSTNAME} >> ~/.ssh/known_hosts 2>&1 || {
            echo "Warning: ssh-keyscan failed, but continuing..."
          }
          chmod 644 ~/.ssh/known_hosts
          
          echo "SSH key prepared successfully"

      - name: Rsync release to server
        run: |
          set -e
          RELEASE=${GITHUB_SHA}
          echo "Deploying release ${RELEASE} to ${SSH_USER}@${SSH_HOSTNAME}:${DEPLOY_PATH}/releases/${RELEASE}/"
          rsync -az --delete \
            --exclude ".git" --exclude "node_modules" --exclude ".github" \
            --exclude "vendor" --exclude ".env" --exclude "storage" \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -p ${SSH_PORT:-22}" \
            ./ ${SSH_USER}@${SSH_HOSTNAME}:${DEPLOY_PATH}/releases/${RELEASE}/

      - name: Run remote deploy script
        run: |
          set -e
          RELEASE=${GITHUB_SHA}
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -p ${SSH_PORT:-22} ${SSH_USER}@${SSH_HOSTNAME} "bash ${DEPLOY_PATH}/releases/${RELEASE}/scripts/deploy_remote.sh ${DEPLOY_PATH} ${RELEASE}"
